{"version":3,"sources":["../../src/browser/render.js"],"names":["ReactDOMServer","require","GitBook","React","timing","loadPlugins","HTML","head","innerHTML","payload","scripts","bootstrap","attrs","htmlAttributes","toComponent","title","meta","link","style","__html","map","script","propTypes","PropTypes","object","string","arrayOf","getBootstrapCode","role","render","plugins","initialState","type","measure","browserPlugins","JSON","stringify","context","createContext","currentFile","getState","file","toList","filter","plugin","getPackage","has","relative","getName","toArray","el","renderWithContext","deactivate","renderToString","Head","rewind","htmlEl","concat","html","renderToStaticMarkup","module","exports"],"mappings":"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","file":"render.js","sourcesContent":["const ReactDOMServer = require('gitbook-core/lib/server');\nconst GitBook = require('gitbook-core');\nconst { React } = GitBook;\n\nconst timing = require('../utils/timing');\nconst loadPlugins = require('./loadPlugins');\n\nfunction HTML({head, innerHTML, payload, scripts, bootstrap}) {\n    const attrs = head.htmlAttributes.toComponent();\n\n    return (\n        <html {...attrs}>\n            <head>\n                {head.title.toComponent()}\n                {head.meta.toComponent()}\n                {head.link.toComponent()}\n                {head.style.toComponent()}\n            </head>\n            <body>\n                <div id=\"content\" dangerouslySetInnerHTML={{__html: innerHTML}} />\n                {scripts.map((script) => {\n                    return <script key={script} src={script} />;\n                })}\n                <script type=\"application/payload+json\" dangerouslySetInnerHTML={{__html: payload}} />\n                <script type=\"application/javascript\" dangerouslySetInnerHTML={{__html: bootstrap}} />\n                {head.script.toComponent()}\n            </body>\n        </html>\n    );\n}\nHTML.propTypes = {\n    head:      React.PropTypes.object,\n    innerHTML: React.PropTypes.string,\n    payload:   React.PropTypes.string,\n    bootstrap: React.PropTypes.string,\n    scripts:   React.PropTypes.arrayOf(React.PropTypes.string)\n};\n\n/**\n * Get bootstrap code for a role\n * @param  {String} role\n * @return {String}\n */\nfunction getBootstrapCode(role) {\n    return `(function() { require(\"gitbook-core\").bootstrap({ role: \"${role}\" }) })()`;\n}\n\n/**\n * Render a view using plugins.\n *\n * @param  {OrderedMap<String:Plugin>} plugin\n * @param  {Object} initialState\n * @param  {String} type (\"ebook\" or \"browser\")\n * @param  {String} role\n * @return {String} html\n */\nfunction render(plugins, initialState, type, role) {\n    return timing.measure(\n        'browser.render',\n        () => {\n            // Load the plugins\n            const browserPlugins = loadPlugins(plugins, type);\n            const payload = JSON.stringify(initialState);\n            const context = GitBook.createContext(browserPlugins, initialState);\n\n            const currentFile = context.getState().file;\n\n            const scripts = plugins.toList()\n                .filter(plugin => plugin.getPackage().has(type))\n                .map((plugin) => {\n                    return currentFile.relative('gitbook/plugins/' + plugin.getName() + '.js');\n                })\n                .toArray();\n\n            const el = GitBook.renderWithContext(context, { role });\n\n            // We're done with the context\n            context.deactivate();\n\n            // Render inner body\n            const innerHTML = ReactDOMServer.renderToString(el);\n\n            // Get headers\n            const head = GitBook.Head.rewind();\n\n            // Render whole HTML page\n            const htmlEl = <HTML\n                head={head}\n                innerHTML={innerHTML}\n                payload={payload}\n                bootstrap={getBootstrapCode(role)}\n                scripts={[\n                    currentFile.relative('gitbook/core.js')\n                ].concat(scripts)}\n            />;\n\n            const html = ReactDOMServer.renderToStaticMarkup(htmlEl);\n            return html;\n        }\n    );\n}\n\nmodule.exports = render;\n"]}